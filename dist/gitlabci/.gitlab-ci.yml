stages:
  - build
  - test

# The shared template for Drupal8CI builds and tests.
.drupal8ci_template: &drupal8ci_template
  image: juampynr/drupal8ci:latest
  services:
    - registry.gitlab.com/juampynr/drupal8-gitlab:latest

# The shared template for Drupal8CI tests.
.drupal8ci_test_template: &drupal8ci_test_template
  <<: *drupal8ci_template
  stage: test
  services:
    - registry.gitlab.com/juampynr/drupal8-gitlab:latest
  dependencies:
    - drupal8ci:build
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - vendor/
    policy: pull

## Job to build the environment.
drupal8ci:build:
  <<: *drupal8ci_template
  stage: build
  script:
    - vendor/bin/robo job:build
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - vendor/
  artifacts:
    untracked: true
    paths:
      - ./*

## Job to check coding standards.
drupal8ci:code_sniffer:
  <<: *drupal8ci_template
  script:
    - vendor/bin/robo job:coding-standards
  artifacts:
    paths:
      - artifacts/phpcs/phpcs.xml

## Job to run Unit and Kernel tests.
drupal8ci:unit_kernel_tests:
  <<: *drupal8ci_test_template
  script:
    - vendor/bin/robo job:unit-tests
  artifacts:
    paths:
      - junit.xml
    reports:
      junit: junit.xml

## Job to check test coverage.
drupal8ci:code_coverage:
  <<: *drupal8ci_test_template
  script:
    - vendor/bin/robo job:coverage-report
  artifacts:
    paths:
      - artifacts
  coverage: '/^\s*Lines:\s*\d+.\d+\%/'

# Job to run existing site tests
drupal8ci:existing_site_tests:
  <<: *drupal8ci_test_template
  script:
    - google-chrome-unstable --disable-gpu --headless --no-sandbox --remote-debugging-address=0.0.0.0 --remote-debugging-port=9222 &
    - vendor/bin/robo job:existing-site-tests

